name: Deploy to Azure App Service (Staging)

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AZURE_WEBAPP_NAME: app-20260115
  AZURE_WEBAPP_SLOT: staging
  PROJECT_PATH: ResponseAgent/ResponseAgent.csproj
  DOTNET_VERSION: 8.0.x

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Check for test projects
        id: check-tests
        run: |
          if find . -name "*Tests*.csproj" -print -quit | grep -q .; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "Test projects found"
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "No test projects found"
          fi
      
      - name: Run tests
        if: steps.check-tests.outputs.has_tests == 'true'
        run: dotnet test --configuration Release
      
      - name: Publish application
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} \
            --configuration Release \
            --output ./publish
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: ${{ env.AZURE_WEBAPP_SLOT }}
          package: ./publish
