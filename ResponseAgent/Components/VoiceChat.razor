@using ResponseAgent.Services
@implements IAsyncDisposable
@inject IVoiceChatService VoiceChatService
@inject IJSRuntime JS

<div class="voice-chat-container">
    <div class="voice-chat-card">
        <div class="voice-header">
            <h6>
                <i class="bi bi-mic-fill"></i>
                音声チャット
            </h6>
            @if (isConnected)
            {
                <span class="badge bg-success">
                    <i class="bi bi-circle-fill"></i>
                    接続中
                </span>
            }
            else
            {
                <span class="badge bg-secondary">
                    <i class="bi bi-circle"></i>
                    未接続
                </span>
            }
        </div>

        <div class="voice-body">
            <!-- 音声入力セクション -->
            <div class="voice-input-section mb-3">
                <div class="voice-button-group">
                    <button class="btn btn-lg btn-primary voice-record-btn @(isRecording ? "recording" : "")" 
                            @onclick="@(isRecording ? StopRecordingAsync : StartRecordingAsync)"
                            disabled="@(!isConnected)">
                        <i class="bi @(isRecording ? "bi-stop-circle-fill" : "bi-record-circle-fill")"></i>
                        @(isRecording ? "停止" : "録音")
                    </button>
                    
                    <button class="btn btn-secondary" @onclick="ConnectAsync" disabled="@isConnected">
                        <i class="bi bi-telephone-plus"></i>
                        接続
                    </button>
                    
                    <button class="btn btn-secondary" @onclick="DisconnectAsync" disabled="@(!isConnected)">
                        切断
                    </button>
                </div>

                @if (isRecording)
                {
                    <div class="recording-indicator mt-2">
                        <div class="recording-dot"></div>
                        <span>録音中...</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(statusMessage))
                {
                    <div class="alert alert-info mt-2 mb-0">
                        <small>@statusMessage</small>
                    </div>
                }
            </div>

            <!-- 音声波形表示 -->
            <div class="voice-waveform-container mb-3">
                <canvas @ref="canvasElement" class="voice-waveform"></canvas>
            </div>

            <!-- 音声メッセージ履歴 -->
            <div class="voice-messages">
                @foreach (var message in voiceMessages)
                {
                    <div class="voice-message @message.Role">
                        <div class="message-avatar">
                            @if (message.Role == "user")
                            {
                                <i class="bi bi-person-circle"></i>
                            }
                            else
                            {
                                <i class="bi bi-robot"></i>
                            }
                        </div>
                        <div class="message-content">
                            <div class="message-text">@message.Text</div>
                            <small class="message-time">@message.Timestamp.ToString("HH:mm:ss")</small>
                            
                            @if (!string.IsNullOrEmpty(message.AudioBase64))
                            {
                                <div class="message-audio mt-2">
                                    <audio controls class="w-100">
                                        <source src="data:audio/wav;base64,@message.AudioBase64" type="audio/wav" />
                                        お使いのブラウザは audio 要素に対応していません。
                                    </audio>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private bool isConnected = false;
    private bool isRecording = false;
    private string? statusMessage;
    private List<VoiceMessage> voiceMessages = new();
    private ElementReference canvasElement;
    private IJSObjectReference? jsModule;
    private byte[]? recordedAudioData;

    private class VoiceMessage
    {
        public string Role { get; set; } = "user";
        public string Text { get; set; } = "";
        public string? AudioBase64 { get; set; }
        public DateTime Timestamp { get; set; } = DateTime.Now;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./Components/VoiceChat.razor.js");
            }
            catch (Exception ex)
            {
                statusMessage = $"JavaScript モジュール読み込みエラー: {ex.Message}";
            }
        }
    }

    private async Task ConnectAsync()
    {
        try
        {
            statusMessage = "接続中...";
            StateHasChanged();

            var initialized = await VoiceChatService.InitializeAsync();
            
            if (initialized)
            {
                isConnected = true;
                statusMessage = "接続しました";
                voiceMessages.Clear();
            }
            else
            {
                statusMessage = "接続に失敗しました";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"接続エラー: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task DisconnectAsync()
    {
        try
        {
            statusMessage = "切断中...";
            StateHasChanged();

            await VoiceChatService.DisconnectAsync();
            
            isConnected = false;
            isRecording = false;
            statusMessage = "切断しました";
        }
        catch (Exception ex)
        {
            statusMessage = $"切断エラー: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task StartRecordingAsync()
    {
        try
        {
            statusMessage = "録音を開始しています...";
            StateHasChanged();

            if (jsModule != null)
            {
                await jsModule.InvokeVoidAsync("startRecording");
                isRecording = true;
                statusMessage = "録音中...";
            }
            else
            {
                statusMessage = "JavaScript モジュールが読み込まれていません";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"録音開始エラー: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task StopRecordingAsync()
    {
        try
        {
            statusMessage = "録音を停止しています...";
            StateHasChanged();

            if (jsModule != null)
            {
                recordedAudioData = await jsModule.InvokeAsync<byte[]>("stopRecording");
                isRecording = false;

                if (recordedAudioData != null && recordedAudioData.Length > 0)
                {
                    statusMessage = "音声を処理中...";
                    StateHasChanged();

                    // 音声メッセージを送信
                    var transcribedText = await VoiceChatService.SendVoiceMessageAsync(recordedAudioData);
                    
                    // ユーザーメッセージを追加
                    voiceMessages.Add(new VoiceMessage
                    {
                        Role = "user",
                        Text = transcribedText,
                        AudioBase64 = Convert.ToBase64String(recordedAudioData)
                    });

                    statusMessage = "AI が応答を生成中...";
                    StateHasChanged();

                    // AI 応答を生成
                    var audioResponse = await VoiceChatService.GetAudioResponseAsync(transcribedText);
                    
                    // AI メッセージを追加
                    voiceMessages.Add(new VoiceMessage
                    {
                        Role = "assistant",
                        Text = "音声応答を生成しました",
                        AudioBase64 = Convert.ToBase64String(audioResponse)
                    });

                    statusMessage = "完了";
                }
                else
                {
                    statusMessage = "音声データが取得できませんでした";
                }
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"処理エラー: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (jsModule is not null)
        {
            await jsModule.DisposeAsync();
        }
    }
}
