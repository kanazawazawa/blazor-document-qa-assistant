@using System.Collections.Generic
@using System.Linq
@using System.Text.RegularExpressions

<div class="diff-display-container">
    <div class="diff-header">
        <h5>
            <i class="bi bi-arrow-left-right"></i>
            答弁本文の修正内容
        </h5>
    </div>

    <div class="diff-content">
        @if (!string.IsNullOrWhiteSpace(OriginalText) && !string.IsNullOrWhiteSpace(ModifiedText))
        {
            var originalBody = ExtractAnswerBody(OriginalText);
            var modifiedBody = ExtractAnswerBody(ModifiedText);
            
            <div class="diff-inline-container">
                <!-- 修正前 -->
                <div class="diff-section">
                    <h6 class="diff-section-title">修正前</h6>
                    <div class="diff-text-block">
                        @foreach (var segment in GetDiffSegments(originalBody, modifiedBody, isOriginal: true))
                        {
                            @if (segment.IsChanged)
                            {
                                <span class="diff-removed">@segment.Text</span>
                            }
                            else
                            {
                                <span>@segment.Text</span>
                            }
                        }
                    </div>
                </div>

                <!-- 修正後 -->
                <div class="diff-section">
                    <h6 class="diff-section-title">修正後</h6>
                    <div class="diff-text-block">
                        @foreach (var segment in GetDiffSegments(originalBody, modifiedBody, isOriginal: false))
                        {
                            @if (segment.IsChanged)
                            {
                                <span class="diff-added">@segment.Text</span>
                            }
                            else
                            {
                                <span>@segment.Text</span>
                            }
                        }
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                修正前後のテキストを入力してください。
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public string OriginalText { get; set; } = string.Empty;

    [Parameter]
    public string ModifiedText { get; set; } = string.Empty;

    private class DiffSegment
    {
        public string Text { get; set; } = string.Empty;
        public bool IsChanged { get; set; }
    }

    /// <summary>
    /// 答弁本文のみを抽出
    /// </summary>
    private string ExtractAnswerBody(string text)
    {
        if (string.IsNullOrWhiteSpace(text))
            return string.Empty;

        var match = Regex.Match(text, @"【答弁本文】\s*(.*)", RegexOptions.Singleline);
        if (match.Success)
        {
            return match.Groups[1].Value.Trim();
        }

        return text;
    }

    /// <summary>
    /// 句点（。）で区切った段落単位で差分を計算
    /// </summary>
    private List<DiffSegment> GetDiffSegments(string original, string modified, bool isOriginal)
    {
        var result = new List<DiffSegment>();
        
        // 句点で区切る（。と！と？）
        var originalParagraphs = Regex.Split(original, @"(?<=[。！？])");
        var modifiedParagraphs = Regex.Split(modified, @"(?<=[。！？])");

        // 段落ごとに比較
        for (int i = 0; i < Math.Max(originalParagraphs.Length, modifiedParagraphs.Length); i++)
        {
            var origPara = i < originalParagraphs.Length ? originalParagraphs[i].Trim() : "";
            var modPara = i < modifiedParagraphs.Length ? modifiedParagraphs[i].Trim() : "";

            if (string.IsNullOrEmpty(origPara) && string.IsNullOrEmpty(modPara))
                continue;

            if (origPara == modPara)
            {
                // 変更がない段落
                if (!string.IsNullOrEmpty(origPara))
                {
                    result.Add(new DiffSegment { Text = origPara + (origPara.EndsWith("。") || origPara.EndsWith("！") || origPara.EndsWith("？") ? "" : ""), IsChanged = false });
                }
            }
            else if (string.IsNullOrEmpty(origPara))
            {
                // 追加された段落
                if (isOriginal)
                    continue;
                result.Add(new DiffSegment { Text = modPara, IsChanged = true });
            }
            else if (string.IsNullOrEmpty(modPara))
            {
                // 削除された段落
                if (!isOriginal)
                    continue;
                result.Add(new DiffSegment { Text = origPara, IsChanged = true });
            }
            else
            {
                // 同じ段落内で単語レベルの差分を計算
                var wordDiff = GetWordLevelDiff(origPara, modPara);
                
                if (isOriginal)
                {
                    foreach (var seg in wordDiff.Where(s => !s.IsAdded))
                    {
                        result.Add(new DiffSegment { Text = seg.Text, IsChanged = seg.IsRemoved });
                    }
                }
                else
                {
                    foreach (var seg in wordDiff.Where(s => !s.IsRemoved))
                    {
                        result.Add(new DiffSegment { Text = seg.Text, IsChanged = seg.IsAdded });
                    }
                }
            }
        }

        return result;
    }

    private class WordDiff
    {
        public string Text { get; set; } = string.Empty;
        public bool IsAdded { get; set; }
        public bool IsRemoved { get; set; }
    }

    /// <summary>
    /// 単語レベルの差分を計算
    /// </summary>
    private List<WordDiff> GetWordLevelDiff(string original, string modified)
    {
        var result = new List<WordDiff>();
        
        // 簡易的な単語分割（日本語対応）
        var origWords = SplitWords(original);
        var modWords = SplitWords(modified);

        var lcs = ComputeLCS(origWords, modWords);
        
        int i = 0, j = 0, k = 0;
        
        while (i < origWords.Count || j < modWords.Count)
        {
            if (k < lcs.Count && i < origWords.Count && j < modWords.Count && 
                origWords[i] == lcs[k] && modWords[j] == lcs[k])
            {
                // 同じ単語
                result.Add(new WordDiff { Text = origWords[i], IsAdded = false, IsRemoved = false });
                i++; j++; k++;
            }
            else if (k < lcs.Count && i < origWords.Count && origWords[i] == lcs[k])
            {
                // 追加単語
                result.Add(new WordDiff { Text = modWords[j], IsAdded = true, IsRemoved = false });
                j++;
            }
            else if (k < lcs.Count && j < modWords.Count && modWords[j] == lcs[k])
            {
                // 削除単語
                result.Add(new WordDiff { Text = origWords[i], IsAdded = false, IsRemoved = true });
                i++;
            }
            else if (i < origWords.Count && j < modWords.Count)
            {
                // 置換
                result.Add(new WordDiff { Text = origWords[i], IsAdded = false, IsRemoved = true });
                result.Add(new WordDiff { Text = modWords[j], IsAdded = true, IsRemoved = false });
                i++; j++;
            }
            else if (i < origWords.Count)
            {
                result.Add(new WordDiff { Text = origWords[i], IsAdded = false, IsRemoved = true });
                i++;
            }
            else if (j < modWords.Count)
            {
                result.Add(new WordDiff { Text = modWords[j], IsAdded = true, IsRemoved = false });
                j++;
            }
        }

        return result;
    }

    /// <summary>
    /// 日本語対応の単語分割
    /// </summary>
    private List<string> SplitWords(string text)
    {
        var words = new List<string>();
        var currentWord = "";

        foreach (var c in text)
        {
            if (char.IsWhiteSpace(c))
            {
                if (!string.IsNullOrEmpty(currentWord))
                {
                    words.Add(currentWord);
                    currentWord = "";
                }
            }
            else if (IsKatakana(c) || IsHiragana(c) || IsKanji(c))
            {
                if (!string.IsNullOrEmpty(currentWord) && !IsAlphanumeric(currentWord[currentWord.Length - 1]))
                {
                    words.Add(currentWord);
                    currentWord = "";
                }
                words.Add(c.ToString());
            }
            else if (IsAlphanumeric(c))
            {
                currentWord += c;
            }
            else
            {
                if (!string.IsNullOrEmpty(currentWord))
                {
                    words.Add(currentWord);
                    currentWord = "";
                }
                if (!char.IsWhiteSpace(c))
                    words.Add(c.ToString());
            }
        }

        if (!string.IsNullOrEmpty(currentWord))
            words.Add(currentWord);

        return words;
    }

    private bool IsAlphanumeric(char c)
    {
        return (c >= 'a' && c <= 'z') || (c >= 'A' && c <= 'Z') || (c >= '0' && c <= '9');
    }

    private bool IsHiragana(char c)
    {
        return c >= 0x3040 && c <= 0x309F;
    }

    private bool IsKatakana(char c)
    {
        return c >= 0x30A0 && c <= 0x30FF;
    }

    private bool IsKanji(char c)
    {
        return (c >= 0x4E00 && c <= 0x9FFF) || (c >= 0x3400 && c <= 0x4DBF);
    }

    /// <summary>
    /// LCS（最長共通部分列）を計算
    /// </summary>
    private List<string> ComputeLCS(List<string> a, List<string> b)
    {
        int m = a.Count;
        int n = b.Count;
        int[,] dp = new int[m + 1, n + 1];

        for (int i = 1; i <= m; i++)
        {
            for (int j = 1; j <= n; j++)
            {
                if (a[i - 1] == b[j - 1])
                    dp[i, j] = dp[i - 1, j - 1] + 1;
                else
                    dp[i, j] = Math.Max(dp[i - 1, j], dp[i, j - 1]);
            }
        }

        var lcs = new List<string>();
        int x = m, y = n;

        while (x > 0 && y > 0)
        {
            if (a[x - 1] == b[y - 1])
            {
                lcs.Insert(0, a[x - 1]);
                x--;
                y--;
            }
            else if (dp[x - 1, y] > dp[x, y - 1])
            {
                x--;
            }
            else
            {
                y--;
            }
        }

        return lcs;
    }
}
